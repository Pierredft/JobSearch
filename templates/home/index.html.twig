{% extends 'base.html.twig' %}

{% block title %}Dashboard - Job Search ERP{% endblock %}

{% block body %}
<div class="fade-in">
    <div class="flex-between mb-xl">
        <h1 class="page-title mb-0">üìä Dashboard</h1>
        <a href="{{ path('app_application_new') }}" class="btn btn-primary">
            ‚ûï Nouvelle candidature
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-label">Total Candidatures</div>
            <div class="stat-value">{{ totalApplications }}</div>
            <div class="stat-description">Candidatures enregistr√©es</div>
        </div>

        <div class="stat-card success">
            <div class="stat-label">Taux de r√©ponse</div>
            <div class="stat-value">{{ responseRate }}%</div>
            <div class="stat-description">Des candidatures ont re√ßu une r√©ponse</div>
        </div>

        <div class="stat-card warning">
            <div class="stat-label">Taux de succ√®s</div>
            <div class="stat-value">{{ successRate }}%</div>
            <div class="stat-description">Retours positifs</div>
        </div>

        <div class="stat-card info">
            <div class="stat-label">Sans retour</div>
            <div class="stat-value">{{ statsByStatus['no_response'].count ?? 0 }}</div>
            <div class="stat-description">En attente de r√©ponse</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-container">
            <h3 class="chart-title">üìà √âvolution journali√®re (30 jours)</h3>
            <canvas id="dailyChart"></canvas>
        </div>
        
        <div class="chart-container">
            <h3 class="chart-title">üìÖ √âvolution mensuelle</h3>
            <canvas id="monthlyChart"></canvas>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">üìä R√©partition par statut</h3>
            <canvas id="statusChart"></canvas>
        </div>

        <div class="chart-container">
            <h3 class="chart-title">üè∑Ô∏è R√©partition par secteur</h3>
            <canvas id="sectorChart"></canvas>
        </div>
    </div>

    <!-- Recent Applications -->
    {% if recentApplications|length > 0 %}
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">üìù Candidatures r√©centes</h2>
            <a href="{{ path('app_application_index') }}" class="btn btn-secondary btn-sm">Voir tout</a>
        </div>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Poste</th>
                        <th>Entreprise</th>
                        <th>Plateforme</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for application in recentApplications %}
                    <tr>
                        <td data-label="Date">{{ application.applicationDate|date('d/m/Y') }}</td>
                        <td data-label="Poste"><strong>{{ application.jobTitle }}</strong></td>
                        <td data-label="Entreprise">{{ application.company.name }}</td>
                        <td data-label="Plateforme">{{ application.platform.name }}</td>
                        <td data-label="Statut">
                            <span class="badge badge-{{ application.status.badge }}">
                                {{ application.status.label }}
                            </span>
                        </td>
                        <td data-label="Actions">
                            <a href="{{ path('app_application_show', {'id': application.id}) }}" class="btn btn-sm btn-secondary">
                                üëÅÔ∏è Voir
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card text-center">
        <h3>Aucune candidature pour le moment</h3>
        <p class="text-secondary mb-lg">Commencez par ajouter votre premi√®re candidature !</p>
        <a href="{{ path('app_application_new') }}" class="btn btn-primary">
            ‚ûï Ajouter une candidature
        </a>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Shared Chart Options
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    precision: 0
                }
            }
        }
    };

    // Daily Chart
    const dailyCtx = document.getElementById('dailyChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: {{ dailyLabels|json_encode|raw }},
            datasets: [{
                label: 'Candidatures',
                data: {{ dailyData|json_encode|raw }},
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 3,
                pointBackgroundColor: '#10B981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: commonOptions
    });

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: {{ monthlyLabels|json_encode|raw }},
            datasets: [{
                label: 'Candidatures',
                data: {{ monthlyData|json_encode|raw }},
                backgroundColor: '#4F46E5',
                borderRadius: 4,
                barPercentage: 0.6
            }]
        },
        options: commonOptions
    });

    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Envoy√©es', 'Sans retour', 'Retour n√©gatif', 'Retour positif'],
            datasets: [{
                data: [
                    {{ statsByStatus['sent'].count ?? 0 }},
                    {{ statsByStatus['no_response'].count ?? 0 }},
                    {{ statsByStatus['negative_response'].count ?? 0 }},
                    {{ statsByStatus['positive_response'].count ?? 0 }}
                ],
                backgroundColor: [
                    '#3B82F6',
                    '#F59E0B',
                    '#EF4444',
                    '#10B981'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // Sector Chart
    const sectorCtx = document.getElementById('sectorChart').getContext('2d');
    new Chart(sectorCtx, {
        type: 'pie',
        data: {
            labels: {{ sectorLabels|json_encode|raw }},
            datasets: [{
                data: {{ sectorData|json_encode|raw }},
                backgroundColor: [
                    '#8B5CF6',
                    '#EC4899',
                    '#14B8A6',
                    '#F97316',
                    '#6366F1',
                    '#F43F5E'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
