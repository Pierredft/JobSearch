name: CD - Deploy to O2switch

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to O2switch
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Whitelist IP on O2switch
        run: |
          RUNNER_IP=$(curl -s https://ifconfig.me/ip)
          echo "Whitelisting IP: $RUNNER_IP"
          curl -s -u "${{ secrets.CPANEL_USER }}:${{ secrets.CPANEL_TOKEN }}" \
            "https://${{ secrets.SSH_HOST }}:2083/execute/Msg/send_message" \
            > /dev/null || true
          
          # Using the specific O2switch whitelist endpoint (try standard cPanel API first or fallback)
          # Since the specialized endpoint might vary, we use the standard cPanel API to add IP to firewall if available
          # For O2switch specifically, we often use a direct call if the "Autorisation SSH" tool API is exposed.
          # Based on standard O2switch automation without custom endpoint knowledge, we try the known path:
          
          curl -s "https://${{ secrets.CPANEL_USER }}:${{ secrets.CPANEL_TOKEN }}@${{ secrets.SSH_HOST }}:2083/frontend/o2switch/o2switch-ssh-whitelist/index.live.php?ip=${RUNNER_IP}&note=GitHubAction"
          
          # Wait a few seconds for firewall propagation
          sleep 10

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Maintenance mode (optional, only if you have a maintenance page)
            # touch public/maintenance.php
            
            # Update code
            git pull origin main
            
            # Install dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Database migrations
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod
            
            # Clear and warm up cache
            php bin/console cache:clear --env=prod
            
            # Assets
            php bin/console asset-mapper:compile --env=prod
            
            # Disable maintenance mode
            # rm public/maintenance.php
            
            echo "Deployment successful!"
