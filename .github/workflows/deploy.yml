name: CD - Deploy to O2switch

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to O2switch
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get runner IP
        run: curl https://ifconfig.me/ip

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Maintenance mode (optional, only if you have a maintenance page)
            # touch public/maintenance.php
            
            # Update code
            git pull origin main
            
            # Install dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Database migrations
            php bin/console doctrine:migrations:migrate --no-interaction --env=prod
            
            # Clear and warm up cache
            php bin/console cache:clear --env=prod
            
            # Assets
            php bin/console asset-mapper:compile --env=prod
            
            # Disable maintenance mode
            # rm public/maintenance.php
            
            echo "Deployment successful!"
