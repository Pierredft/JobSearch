name: CD - Deploy to O2switch

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to O2switch
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Trigger Deployment Webhook
        run: |
          echo "Triggering deployment via Webhook..."
          response=$(curl -s -w "%{http_code}" -o response.txt "https://${{ secrets.SSH_HOST }}/deploy.php?token=${{ secrets.DEPLOY_TOKEN }}")
          
          echo "Response Code: $response"
          cat response.txt
          
          if [ "$response" -ne 200 ]; then
            echo "Deployment Failed!"
            exit 1
          fi
